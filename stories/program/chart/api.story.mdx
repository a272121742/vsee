import { Story, Preview, Meta, Props } from '@storybook/addon-docs/blocks';

<Meta title="方案/数据图表/接口规范" />

# 前端图表接口规范

## 总览

为规范图表类型开发，前端将基于所有的产品、项目以及未来可开发的平台，定义图表类型的如下原则：

1. 客户端必须使用支持**数据接口规范**的可视化产品，包括`echarts`、`highcharts`、`antv`等，经过鉴定，这些相关成熟产品均支持`dataset`模式，这对服务端友好，对客户端的**复用性**、**可变性**、**可维护性**将有显著的提高。
2. 客户端的目标就是消费数据、组装数据、展示数据，其中：
   1. **消费数据** - 按照**接口规范**从服务端获取数据；
   2. **组装数据** - 将标准数据模型`dataset`中的数据按照特定图表类型中的数据模式进行填充和更新；
   3. **展示数据** - 范围明确定义在数据**格式转换**、数据**类型转换**、展示**样式转换**、**容错矫正**，后面给出展示数据的定义。

## 数据接口规范

接口中数据`body`格式**完全严格遵照**平台定义的格式，`code`定义响应代码，`data`定义响应数据，`msg`定义响应消息：

```javascript
// HTTP Response Body
{
  // Number - 响应代码，非`0`即业务错误
  code: 0,
  // JSON - 响应数据
  data{
    // 数据源：`source`只能是一个二维数组`Array<Array<Object>>`
    source: [
      // 数组的第一行是纬度，维度第一个是维度名称，剩余是维度分类
      [ 'product',        '2015',        '2016',        '2017' ],
      // 数组的剩余行是度量集合，度量集合第一个是度量名称，后面是各维度分类下的度量值
      [ 'Matcha Latte',    43.3,          85.8,          93.7  ],
      [ 'Milk Tea',        83.1,          73.4,          55.1  ],
      [ 'Cheese Cocoa',    86.4,          65.2,          82.5  ],
      [ 'Walnut Brownie',  72.4,          53.9,          39.1  ]
    ],
    /**
     * 如果除了数据源`source`，还有一些其他数据需要服务端传回，可以在这里传回，总体原则就是保持服务端响应接口的不变性。
     */
  },
  // String - 响应消息
  msg: '',
}
```

## 展示数据

为了更好的展示数据（不限定为数字，但包含数字、日期、时间等），特定义数据展示的范畴：

1. 数据格式转换，例如：
   1. **前置转换**，在数据的前面增加前缀符号，例如货币类型"$"、"¥"，例如数学符号"+"、"-"等；
   2. **后置转换**，在数据的后面增加后缀符号，例如百分号`%`，例如单位`KM`等；
   3. **格式化**，例如数字增加","作为分割符号，日期通过`YYMMDD`进行格式化；
   4. **本地化**（未有特定案例，定义但暂不使用）
2. 数据类型转换，针对时间日期格式，客户端需要按照所使用图表类型进行转换，在`echarts`中，虽然对时间数据处理的兼容性很强，但仍然有需要开发者额外处理的特例，服务端一律使用时区格式；
3. 数据样式转换，例如颜色、边框、大小、字体等和视觉展示相关的属性；
4. 容错矫正，开发时要充分考虑数据异常情况，并作包容性处理，例如**长度过长**、**大小超出阀值**、**数据为空**，对展示的数据进行测试，并联合业务、测试、UI设计师进行微调；

## 数据范畴

1. 数据源（dataset），见上方数据接口规范；
2. 标记（标记点、标记线、标记区域），放到`body.data`中；
3. 协商数据，对于必须由服务端提供的其他数据，都会放到`body.data`中；

## 数值计算

前端一般不处理数值计算，前端的范畴始终都是数据的消费者，计算的任务都应该交给数据的提供者（服务端或数据库）。但难免会有需要进行数值计算的地方，这些地方是需要和业务进行沟通确认才能继续进行的：

1. 绝对值计算 - 去除数值符号，通过颜色进行视觉映射；
2. 自然运算 - 尤其是对于**加法**和**除法**运算，在一定需要客户端处理时，需要及时和业务沟通并做好容错矫正工作。

## 数值异常

数值异常主要包含三个方面：

1. 空值展示：如果遇到数据项不存在，前后端约定使用`null`作为空值，但绝对不能使用`0`来表示空值数据。如果遇到空值数据，一定要询问业务，了解数据的实际情况，做好容错矫正处理。
2. 空值计算：在比较型图表中，例如环图，会有比值计算，当遇到**除零**问题时，不会导致数据计算错误，但会引起错误的视觉引导，例如完成率是`Infinity`或者`100%`的错误信息提示。如果遇到空值计算，一定要询问业务，了解实际的规则，做好容错矫正处理。
3. 非数计算：图表类型组件在进行计算时，大多能友好处理**非数字**类型的计算，但是遇到需要手工处理的**非数计算**问题，就需要对数据进行容错矫正处理了。
